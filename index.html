<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>University Resources</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f2f4f8;
      margin: 0;
      padding: 20px;
    }

    h2 {
      color: #333;
      text-align: center;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    .selectors {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: space-between;
    }

    select, button {
      flex: 1 1 45%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      border: none;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    #files {
      margin-top: 30px;
    }

    #files label {
      display: block;
      margin: 10px 0;
      background: #eef6ff;
      padding: 10px;
      border-radius: 6px;
    }

    .action-buttons {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: space-between;
    }

    @media (max-width: 600px) {
      .selectors, .action-buttons {
        flex-direction: column;
      }

      select, button {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>University Resource Finder</h2>

    <div class="selectors">
      <select id="semester" onchange="updateCourses()">
        <option value="">-- Select Semester --</option>
        <option value="Semester1">Semester 1</option>
        <option value="Semester2">Semester 2</option>
        <option value="Semester3">Semester 3</option>
        <option value="Semester4">Semester 4</option>
        <option value="Semester5">Semester 5</option>
        <option value="Semester6">Semester 6</option>
        <option value="Semester7">Semester 7</option>
        <option value="Semester8">Semester 8</option>
      </select>

      <select id="exam" onchange="updateCourses()">
        <option value="">-- Select Exam Type --</option>
        <option value="Mid">Mid</option>
        <option value="Final">Final</option>
      </select>

      <select id="filetype">
        <option value="">-- Select File Type --</option>
        <option value="Notes">Notes</option>
        <option value="CourseMaterials">Course Materials</option>
        <option value="PreviousQuestions">Previous Questions</option>
      </select>

      <select id="course">
        <option value="">-- Select Course --</option>
      </select>
    </div>

    <div class="action-buttons">
      <button onclick="fetchFiles()">Search</button>
    </div>

    <div id="files"><h3>Files:</h3></div>

    <div class="action-buttons" id="telegramSection" style="display: none;">
      <button onclick="selectAllFiles()">Select All Files</button>
      <button onclick="sendSelectedToTelegram()">Get it on Telegram</button>
    </div>
  </div>

  <script>
    const GITHUB_USERNAME = "11UCRES";
    const REPO_NAME = "cse";

    const tg = window.Telegram.WebApp;
    tg.expand();

    async function updateCourses() {
      const semester = document.getElementById("semester").value;
      const exam = document.getElementById("exam").value;
      const courseSelect = document.getElementById("course");
      courseSelect.innerHTML = '<option value="">-- Select Course --</option>';

      if (!semester || !exam) return;

      const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${semester}/${exam}`;
      try {
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error("Could not fetch course list.");
        const data = await res.json();

        data.forEach(item => {
          if (item.type === "dir") {
            const opt = document.createElement("option");
            opt.value = item.name;
            opt.textContent = item.name;
            courseSelect.appendChild(opt);
          }
        });
      } catch (err) {
        console.error("Error loading course folders:", err);
      }
    }

    async function fetchFiles() {
      const semester = document.getElementById("semester").value;
      const exam = document.getElementById("exam").value;
      const course = document.getElementById("course").value;
      const filetype = document.getElementById("filetype").value;
      const filesDiv = document.getElementById("files");
      const telegramDiv = document.getElementById("telegramSection");
      filesDiv.innerHTML = "<h3>Files:</h3>";
      telegramDiv.style.display = "none";

      if (!semester || !exam || !course || !filetype) {
        alert("Please select all fields.");
        return;
      }

      const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${semester}/${exam}/${course}/${filetype}`;

      try {
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error("Path not found or no files.");
        const files = await res.json();

        if (!Array.isArray(files)) throw new Error("No files found.");

        files.forEach(file => {
          if (file.type === "file") {
            const label = document.createElement("label");
            const input = document.createElement("input");
            input.type = "checkbox";
            input.value = file.download_url;
            label.appendChild(input);
            label.appendChild(document.createTextNode(" " + file.name));
            filesDiv.appendChild(label);
          }
        });

        if (files.length > 0) {
          telegramDiv.style.display = "flex";
        }

      } catch (err) {
        filesDiv.innerHTML += "<p>No files found for the selected combination.</p>";
        console.error(err);
      }
    }

    function selectAllFiles() {
      document.querySelectorAll('#files input[type="checkbox"]').forEach(cb => cb.checked = true);
    }

    async function sendSelectedToTelegram() {
      const selected = Array.from(document.querySelectorAll('#files input[type="checkbox"]:checked'));
      if (selected.length === 0) {
        alert("Please select at least one file.");
        return;
      }

      const user_id = window.Telegram.WebApp.initDataUnsafe?.user?.id;
      const botToken = "YOUR_BOT_TOKEN"; // ⚠️ Replace with your actual bot token

      for (const checkbox of selected) {
        const fileUrl = checkbox.value;

        const sendUrl = `https://api.telegram.org/bot${botToken}/sendDocument`;
        const payload = {
          chat_id: user_id,
          document: fileUrl,
          caption: "Requested file from web app"
        };

        try {
          const res = await fetch(sendUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          });

          if (!res.ok) throw new Error("Failed to send file");

        } catch (err) {
          console.error("Error sending file to Telegram:", err);
          alert("Error sending some files.");
        }
      }

      alert("Files sent to your Telegram!");
    }
  </script>

</body>
</html>
